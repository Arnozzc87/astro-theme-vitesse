# 自动化内容发布工作流详解

本文档详细说明了从飞书多维表格发起内容更新到Astro网站自动构建的完整工作流程。

## 整体流程图

```
飞书多维表格 → 自动化触发 → Webhook请求 → API处理内容 → 生成SEO数据 → 创建MD文件 → 触发构建 → Astro重新构建 → 网站更新
```

## 详细工作流程

### 1. 内容创建/更新（飞书端）

1. **内容编辑**：在飞书多维表格中创建或编辑内容（博客文章、项目信息、院校简章或教务通知）
2. **内容结构**：按照预定义的表格结构填写字段，包括标题、摘要、内容和分类等
3. **表格类型**：选择表格类型（blog、project、school或notice）标记内容类型
4. **内容提交**：保存记录，触发飞书自动化规则

### 2. 触发Webhook（飞书→API）

1. **自动化触发**：飞书识别到记录创建/更新事件
2. **数据打包**：飞书自动化将表格数据打包成JSON格式
3. **发送请求**：通过HTTP POST请求发送到API的`/webhook/feishu`端点
4. **验证身份**：API验证请求来源和签名以确保安全

### 3. 内容处理（API内部）

1. **数据解析**：`processFeishuData`函数解析飞书表格数据
2. **基础处理**：提取标题、内容、图片等信息
3. **Slug生成**：基于标题生成URL友好的slug
4. **标签处理**：解析标签字符串为数组
5. **元数据组装**：收集作者、分类等元数据

### 4. SEO数据生成（AI增强）

1. **AI提供商选择**：根据配置选择DeepSeek或OpenAI
2. **模板应用**：使用针对教育行业优化的提示词模板
3. **并行生成**：同时生成多个SEO元素（描述、关键词等）
4. **内容类型适配**：根据内容类型生成不同的结构化数据
5. **高级SEO**：生成FAQ、内部链接建议、竞争分析等（根据配置）

### 5. Markdown文件创建

1. **目录确定**：根据内容类型选择对应的内容目录
2. **Frontmatter生成**：创建包含SEO元数据的YAML frontmatter
3. **内容组装**：组合frontmatter、正文内容和FAQ
4. **文件写入**：将完整内容写入Markdown文件
5. **权限保障**：确保目录存在并有写入权限

### 6. 触发网站构建（API→阿里云）

1. **构建方法选择**：根据配置选择SSH、Webhook或本地命令
2. **SSH方式**：
   - 通过SSH连接到阿里云服务器
   - 执行预定义的构建脚本（拉取代码、安装依赖、构建）
3. **Webhook方式**：
   - 向阿里云服务器上的webhook服务发送请求
   - 阿里云服务器接收后执行构建
4. **本地命令方式**：
   - 直接在API服务器上执行构建命令
   - 适用于API和网站在同一服务器的情况

### 7. Astro网站构建

1. **代码更新**：拉取最新代码（包含新增的Markdown文件）
2. **依赖安装**：安装或更新必要的依赖包
3. **内容处理**：Astro读取并处理所有内容源文件
4. **静态生成**：将内容转换为静态HTML、CSS和JavaScript
5. **资源优化**：压缩图片、CSS和JavaScript
6. **输出构建**：生成完整的静态网站文件到`dist`目录

### 8. 部署与通知

1. **文件部署**：将构建好的文件复制到网站根目录
2. **缓存清理**：清理相关缓存确保内容更新可见
3. **构建结果通知**：通过飞书webhook发送构建结果通知
4. **错误处理**：若构建失败，发送错误通知

## 技术栈概览

- **内容源**：飞书多维表格
- **API服务**：Node.js + Express
- **AI增强**：DeepSeek v3 / OpenAI
- **静态生成**：Astro框架
- **构建触发**：SSH / Webhook / 本地命令
- **部署目标**：阿里云服务器

## 优势与特点

1. **高度自动化**：从内容创建到网站发布全流程自动化
2. **AI增强SEO**：利用AI技术自动生成高质量SEO数据
3. **多模型支持**：支持DeepSeek和OpenAI，灵活切换
4. **并行处理**：批量生成内容，提高效率
5. **灵活部署**：支持多种构建和部署方式
6. **错误处理**：完善的错误处理和回退策略
7. **教育行业优化**：针对成人教育行业的专业SEO模板

## 常见问题排查

1. **内容未更新**：
   - 检查飞书自动化规则是否正确配置
   - 检查API服务日志是否接收到请求
   - 验证构建触发是否成功执行

2. **SEO数据生成失败**：
   - 检查AI服务密钥是否有效
   - 检查网络连接是否稳定
   - 查看日志中的详细错误信息

3. **构建失败**：
   - 检查SSH连接和凭证是否正确
   - 验证构建脚本路径和权限
   - 查看构建日志获取详细错误
